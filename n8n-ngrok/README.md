# n8n + ngrok Automated Setup

This setup provides a fully automated n8n instance with ngrok integration for webhook URLs. The solution eliminates manual intervention by automatically detecting ngrok tunnel URLs and configuring n8n webhooks.

## üåü Features

- **Fully Automated**: No manual steps required after initial setup
- **Free ngrok Domain**: Uses ngrok's free tier with auto-generated URLs
- **Auto-Discovery**: Automatically detects and updates webhook URLs
- **Persistent Storage**: PostgreSQL database with data persistence
- **Health Monitoring**: Built-in health checks for all services
- **AI Integration**: Optional Ollama service for AI workflows
- **Development Ready**: Optimized for local development and testing

## üöÄ Quick Start

### Prerequisites

- Docker and Docker Compose installed
- ngrok account (free tier works fine)
- Your ngrok authtoken

### 1. Initial Setup

```bash
# Navigate to the n8n-ngrok directory
cd n8n-ngrok

# Run the automated setup script
./setup.sh
```

The setup script will:

- Generate secure encryption keys and passwords
- Prompt for your ngrok authtoken
- Create optimized configuration files
- Set up directory structure

### 2. Start Services

```bash
# Start all services
docker compose up -d

# Or start with AI features (Ollama)
docker compose --profile ollama up -d
```

### 3. Access Your Services

- **n8n Interface**: http://localhost:5678
- **ngrok Dashboard**: http://localhost:4040
- **Database**: PostgreSQL on localhost:5432

## üìã Services Overview

### Core Services

1. **n8n**: Automation platform running on port 5678
2. **PostgreSQL**: Database for n8n data persistence
3. **ngrok**: Tunnel service exposing n8n to the internet
4. **ngrok-updater**: Custom service that monitors ngrok and updates n8n webhooks

### Optional Services

1. **Ollama**: AI/LLM service for advanced workflows (use `--profile ollama`)

## üîß How It Works

### Automatic Webhook Configuration

1. **ngrok** creates a tunnel to the n8n container
2. **ngrok-updater** monitors the ngrok API for tunnel URLs
3. When a new URL is detected, it updates n8n's webhook configuration
4. n8n automatically uses the new URL for all webhook-based workflows

### Service Dependencies

```
PostgreSQL ‚Üí n8n ‚Üí ngrok ‚Üí ngrok-updater
```

Each service waits for its dependencies to be healthy before starting.

## üìÅ File Structure

```
n8n-ngrok/
‚îú‚îÄ‚îÄ docker-compose.yml      # Main orchestration file
‚îú‚îÄ‚îÄ .env                    # Environment configuration
‚îú‚îÄ‚îÄ setup.sh               # Automated setup script
‚îú‚îÄ‚îÄ Dockerfile.updater     # Custom updater service
‚îú‚îÄ‚îÄ ngrok-updater.py       # Python script for URL monitoring
‚îú‚îÄ‚îÄ webhook-url.txt        # Current webhook URL (auto-generated)
‚îú‚îÄ‚îÄ logs/                  # Application logs
‚îî‚îÄ‚îÄ README.md             # This file
```

## üîç Monitoring and Troubleshooting

### View Logs

```bash
# All services
docker compose logs -f

# Specific service
docker compose logs -f ngrok-updater
docker compose logs -f n8n
docker compose logs -f ngrok
```

### Check Service Status

```bash
# Service status
docker compose ps

# ngrok tunnels
curl http://localhost:4040/api/tunnels | jq

# Current webhook URL
cat webhook-url.txt
```

### Health Checks

All services include health checks:

- **PostgreSQL**: Database connectivity
- **n8n**: HTTP health endpoint
- **ngrok**: API availability
- **ngrok-updater**: Process monitoring

## ‚öôÔ∏è Configuration

### Environment Variables

Key configurations in `.env`:

```bash
# n8n Configuration
N8N_ENCRYPTION_KEY=<auto-generated>
N8N_PORT=5678
TIMEZONE=UTC

# ngrok Configuration
NGROK_AUTHTOKEN=<your-token>
NGROK_REGION=us

# Update frequency (seconds)
UPDATE_INTERVAL=30
```

### Custom Domains

For production use with custom domains:

1. Upgrade to ngrok Pro plan
2. Add your domain in ngrok dashboard
3. Update docker-compose.yml with domain configuration

## üîÑ Workflow Integration

### Using Webhooks in n8n

1. Create a workflow with a webhook trigger
2. The webhook URL will automatically use the ngrok tunnel
3. External services can call your webhooks reliably
4. URLs update automatically if ngrok restarts

### Example Webhook URL

Your webhook URLs will look like:

```
https://abc123def456.ngrok-free.app/webhook/your-webhook-id
```

## üõ†Ô∏è Development Commands

```bash
# Start development environment
docker compose up -d

# Rebuild custom services
docker compose build ngrok-updater

# Reset all data (destructive)
docker compose down -v
docker system prune -f

# Update n8n image
docker compose pull n8n
docker compose up -d n8n
```

## üîí Security Considerations

### Development Setup

- Uses HTTP for simplicity in local development
- Database credentials are auto-generated
- No SSL/TLS termination (handled by ngrok)

### Production Recommendations

- Enable HTTPS in n8n configuration
- Use strong database passwords
- Consider ngrok Pro for custom domains
- Enable n8n user management
- Use secrets management for sensitive data

## ü§ù Contributing

To improve this setup:

1. Fork the repository
2. Create a feature branch
3. Test your changes thoroughly
4. Submit a pull request

## üìù License

This setup is provided as-is for development and testing purposes.

## üÜò Support

### Common Issues

1. **ngrok auth failed**: Check your authtoken in `.env`
2. **n8n not accessible**: Wait for all health checks to pass
3. **Webhook URLs not updating**: Check ngrok-updater logs
4. **Database connection failed**: Ensure PostgreSQL is healthy

### Getting Help

- Check service logs: `docker compose logs -f [service-name]`
- Verify health status: `docker compose ps`
- Reset environment: `docker compose down -v && docker compose up -d`

---

üéâ **Enjoy your automated n8n + ngrok setup!** Your webhooks will work seamlessly without manual intervention.
